<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Hole Viewer</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .scene-container {
            position: fixed;
            width: 100vw;
            height: 100vh;
        }
        
        #starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
            background-color: transparent;
            position: absolute;
            z-index: 2;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.2em;
            z-index: 3;
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <canvas id="starfield"></canvas>
        <div class="loading" id="loading">Loading Black Hole...</div>
        <model-viewer
            src="/models/black_hole.glb"
            camera-controls
            auto-rotate
            rotation-per-second="30deg"
            camera-orbit="0deg 90deg 15m"
            min-camera-orbit="auto auto 5m"
            max-camera-orbit="auto auto 30m"
            orbit-sensitivity="0.5"
            zoom-sensitivity="0.3"
            environment-image="legacy"
            shadow-intensity="1"
            exposure="1.0"
            interaction-prompt="none"
            loading="eager"
            camera-target="0m 0m 0m"
            field-of-view="30deg"
            skybox-image="legacy">
        </model-viewer>
    </div>

    <script>
        // Initialize Three.js scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('starfield'),
            alpha: true,
            antialias: false,
            powerPreference: "high-performance"
        });
        
        renderer.setClearColor(0x000000, 0);
        renderer.setPixelRatio(window.devicePixelRatio > 1 ? 2 : 1);
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Create stars
        const starsGeometry = new THREE.BufferGeometry();
        const starsMaterial = new THREE.PointsMaterial({
            color: 0xFFFFFF,
            size: 0.1,
            transparent: true,
            sizeAttenuation: true,
            depthWrite: false  // Added to prevent z-fighting
        });

        const numberOfStars = window.innerWidth < 768 ? 5000 : 10000;
        const starsVertices = new Float32Array(numberOfStars * 3);
        
        for(let i = 0; i < numberOfStars * 3; i += 3) {
            starsVertices[i] = (Math.random() - 0.5) * 2000;
            starsVertices[i + 1] = (Math.random() - 0.5) * 2000;
            starsVertices[i + 2] = (Math.random() - 0.5) * 2000;
        }

        starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
        const stars = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(stars);

        camera.position.z = 5;

        // Animation
        let lastTime = 0;
        const rotationSpeed = 0.0001;
        
        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            if (currentTime - lastTime < 16) {
                return;
            }
            
            stars.rotation.x += rotationSpeed;
            stars.rotation.y += rotationSpeed;
            renderer.render(scene, camera);
            
            lastTime = currentTime;
        }

        // Handle resize
        function resizeRenderer() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        let resizeTimeout;
        window.addEventListener('resize', () => {
            if (resizeTimeout) clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeRenderer, 250);
        });

        // Model viewer events
        const modelViewer = document.querySelector('model-viewer');
        const loadingElement = document.getElementById('loading');

        modelViewer.addEventListener('load', () => {
            loadingElement.style.display = 'none';
        });

        modelViewer.addEventListener('error', (error) => {
            console.error('Error loading model:', error);
            loadingElement.textContent = 'Error loading model. Please refresh.';
        });

        animate();
    </script>
</body>
</html>